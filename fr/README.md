[EN](../README.md) | **FR**

<div>
  <img src="https://browserux.com/img/logos/logo-browserux-inject-sw-assets-300.png" alt="logo vite-plugin-inject-sw-assets"/>
</div>

# BrowserUX Inject SW Assets

> Plugin Vite pour injecter automatiquement des assets statiques dans un service worker personnalis√© (`injectManifest`), pour un support hors ligne complet.

`vite-plugin-inject-sw-assets` est un plugin Vite qui injecte des fichiers statiques suppl√©mentaires dans votre service worker pour les mettre en cache, en compl√©ment de `vite-plugin-pwa` lorsqu‚Äôon utilise la strat√©gie `injectManifest`.

[![npm version](https://img.shields.io/npm/v/vite-plugin-inject-sw-assets.svg)](https://www.npmjs.com/package/vite-plugin-inject-sw-assets)
![vite compatibility](https://img.shields.io/badge/Vite-4%2B%20%7C%205%2B%20%7C%206%2B%20%7C%207%2B-646CFF.svg?logo=vite&logoColor=white)

## Pourquoi ce plugin ?

Lorsqu‚Äôon utilise [`vite-plugin-pwa`](https://github.com/antfu/vite-plugin-pwa) avec la strat√©gie `injectManifest`, le service worker est enti√®rement personnalis√©, et la responsabilit√© de d√©clarer les fichiers √† pr√©cacher repose sur le d√©veloppeur. Workbox injecte automatiquement les fichiers JS, CSS, et HTML r√©f√©renc√©s par Vite, mais les assets statiques comme les images, polices ou fichiers JSON utilis√©s uniquement dans le HTML ne sont pas inclus.

Cela pose un probl√®me courant :

Les images pr√©sentes dans vos fichiers HTML (ex: `<img src="..."`>) ne sont pas pr√©cach√©es automatiquement.

### Ce que fait ce plugin

- üîç Scan automatique des fichiers statiques du dossier `dist/` √† la fin du build
- üñºÔ∏è Rep√®re tous les fichiers statiques correspondant √† des extensions donn√©es  (par d√©faut :  `.png`, `.svg`, `.ico`, `.webp`, `.json`)
- üßº √âvite de doubler les fichiers d√©j√† d√©clar√©s dans votre `manifest.webmanifest` (ex. ic√¥nes PWA)
- ‚öôÔ∏è G√©n√®re un fichier JavaScript injectable dans le service worker

### Avantages

- Automatise une √©tape souvent oubli√©e avec injectManifest
- √âvite les erreurs 404 hors ligne sur des images HTML
- Compatible avec tous les workflows Vite + PWA
- Facilement personnalisable (`extensions`, `excludeFromManifest`, etc.)

## Installation

```bash
npm install vite-plugin-inject-sw-assets --save-dev
```

## Usage

### In your `vite.config.ts` file

```js
import { defineConfig } from 'vite'
import { VitePWA } from 'vite-plugin-pwa'
import { globSync } from 'glob';
import injectSWAssets from 'vite-plugin-inject-sw-assets'

export default defineConfig({
    plugins: [
        injectSWAssets({
            extensions: ['png', 'svg', 'json'] // optional
        }),
        VitePWA({
            strategies: 'injectManifest',
            srcDir: 'src',
            filename: 'sw.js',
            manifest: {
                icons: [/* ... */]
            }
        })
    ]
})
```

### Int√©gration dans le Service Worker (`sw.js`)

```js
import { precacheAndRoute } from 'workbox-precaching'

// Load injected assets (generated by the plugin)
importScripts('sw-assets.js') 

// Files automatically injected by Workbox
precacheAndRoute(self.__WB_MANIFEST)

// Files injected by the plugin
if (self.__INJECTED_ASSETS__) {
    precacheAndRoute(self.__INJECTED_ASSETS__)
}
```

#### Path considerations

- The path passed to `importScripts()` is relative to the service worker file. So if both `sw.js` and `sw-assets.js` are in `dist/`, just use:

```js
importScripts('sw-assets.js') 
```

- If `sw.js` is inside a subdirectory like `dist/src/`, then use:

```js
importScripts('../sw-assets.js')
```

## Exemple de fichier g√©n√©r√©

Fichier `dist/sw-assets.js` :

```js
self.__INJECTED_ASSETS__ = [
    { url: "/images/logo.png", revision: null },
    { url: "/data/data.json", revision: null }
]
```

## Options

| Option                | Type       | Par d√©faut                                             | Description                                                                                   |
| --------------------- | ---------- | ------------------------------------------------------ | --------------------------------------------------------------------------------------------- |
| `distDir`             | `string`   | `"dist"`                                               | R√©pertoire de sortie du build √† scanner pour d√©tecter les fichiers √† injecter                 |
| `output`              | `string`   | `"sw-assets.js"`                                       | Nom du fichier JavaScript g√©n√©r√© contenant les assets inject√©s                                |
| `extensions`          | `string[]` | `['png', 'jpg', 'jpeg', 'svg', 'webp', 'ico', 'json']` | Extensions de fichiers √† inclure dans l‚Äôinjection (ex : images, JSON)                         |
| `excludeFromManifest` | `boolean`  | `true`                                                 | Exclut automatiquement les fichiers d√©j√† r√©f√©renc√©s dans `manifest.webmanifest` (ex : ic√¥nes) |

## Structure du d√©p√¥t

```bash
‚îú‚îÄ‚îÄ dist/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îú‚îÄ‚îÄ types.ts
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ file-scanner.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ manifest-utils.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sw-assets-writer.ts
‚îú‚îÄ‚îÄ tsconfig.json
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ README.md
```

## Fonctionnement interne (en bref)

- Analyse r√©cursive du dossier `dist/`
- Filtres par extensions (configurables)
- Optionnel : exclusion automatique des ic√¥nes d√©j√† r√©f√©renc√©es dans `manifest.webmanifest`
- G√©n√®re un fichier JS (`sw-assets.js`) √† injecter dans `sw.js`

## Licence

MIT ¬© 2025 [Effeilo](https://github.com/Effeilo)